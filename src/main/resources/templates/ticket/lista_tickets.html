<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Tickets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa; 
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

<<<<<<< HEAD
        .container.mt-5 {
            margin-top: 3rem !important;
            margin-bottom: 3rem !important;
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 1300px;
        }
=======
    <!-- Custom styles -->
    <link href="/css/styles.css" rel="stylesheet">
>>>>>>> refs/remotes/origin/pauche

        h2.mb-4 {
            color: #343a40;
            margin-bottom: 1.5rem !important;
            font-weight: 600;
        }


        .alert {
            padding: 15px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
        }

        .alert-success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .alert-danger { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .alert-info { background-color: #d1ecf1; color: #0c5460; border-color: #bee5eb; }

        .table-responsive {
            margin-top: 20px;
        }

        .table {
            width: 100%;
            border-collapse: separate; 
            border-spacing: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); 
            border-radius: 10px;
            overflow: hidden; 
            font-size: 0.9em;
            min-width: 1000px; 
        }

        .table thead.table-dark th {
            background-color: #343a40; 
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
            padding: 12px 18px;
        }

        .table thead.table-dark th:first-child { border-top-left-radius: 10px; }
        .table thead.table-dark th:last-child { border-top-right-radius: 10px; }

        .table tbody tr td {
            padding: 12px 18px;
            border-bottom: 1px solid #e9ecef; 
            white-space: nowrap; 
        }

        .table tbody tr:nth-child(even) {
            background-color: #fdfdfd; 
        }

        .table tbody tr:hover {
            background-color: #f5fafd;
            box-shadow: inset 0 0 0 1px rgba(0, 123, 255, 0.1); 
        }


        td:last-child {
            position: relative;
            text-align: center; 
        }

        .action-group-container {
            display: flex;
            flex-direction: column; 
            gap: 8px; 
            align-items: center; 
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.85em;
            border-radius: 6px;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            justify-content: center; 
            flex-grow: 1; 
        }
        .btn-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
        }
        .btn-sm:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-outline-primary { border: 1px solid #007bff; color: #007bff; background-color: transparent; }
        .btn-outline-primary:hover { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; border: 1px solid #28a745; }
        .btn-success:hover { background-color: #218838; border-color: #1e7e34; }
        .btn-secondary { background-color: #6c757d; color: white; border: 1px solid #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; border-color: #545b62; }
        .btn-outline-info { border: 1px solid #17a2b8; color: #17a2b8; background-color: transparent; }
        .btn-outline-info:hover { background-color: #17a2b8; color: white; }

        .btn-change-state {
            background-color: #fd7e14; 
            color: white;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .btn-change-state:hover {
            background-color: #e66c0d;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-change-priority {
            background-color: #ffc107; 
            color: #343a40; 
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .btn-change-priority:hover {
            background-color: #e0a800;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .main-action-buttons {
            display: flex;
            justify-content: center; 
            gap: 8px; 
            width: 100%; 
            flex-wrap: wrap; 
        }

        @media (max-width: 1200px) {
            .container.mt-5 {
                max-width: 95%;
            }
            .table {
                min-width: 900px;
            }
        }

        @media (max-width: 992px) {
            .table {
                min-width: 768px;
            }
            .table thead.table-dark th, .table tbody tr td {
                padding: 10px 15px;
            }
            .action-group-container {
                 flex-direction: column;
                 align-items: stretch;
            }
            .action-group-container > * {
                 width: 100%;
            }
            .main-action-buttons { 
                flex-direction: column; 
                align-items: stretch;
            }
            .main-action-buttons > * {
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container.mt-5 {
                margin: 20px 15px;
                padding: 20px;
            }
            h2.mb-4 {
                font-size: 1.5em;
            }
            .table {
                font-size: 0.8em;
                min-width: unset;
            }
            .table tbody tr td {
                padding: 8px 10px;
                white-space: normal;
            }
            .btn-sm {
                padding: 6px 10px;
                font-size: 0.75em;
            }
        }

        @media (max-width: 576px) {
            .container.mt-5 {
                margin: 15px 10px;
                padding: 15px;
            }
            .alert {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2 class="mb-4">Lista de Tickets</h2>

        <div class="mb-3">
            <a href="/panel" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Volver al Panel
            </a>
        </div>

        <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
        <div th:if="${message}" class="alert alert-info" role="alert" th:text="${message}"></div>

        <div th:if="${#lists.isEmpty(tickets)}" class="alert alert-info">
            No hay tickets para mostrar.
        </div>

        <div th:unless="${#lists.isEmpty(tickets)}" class="table-responsive">
            <table class="table table-bordered table-hover align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Título</th>
                        <th>Estado</th>
                        <th>Prioridad</th>
						<th>Fecha de Creacion</th>
<!--                        <th sec:authorize="hasAnyRole('ROLE_EMPLEADO', 'ROLE_MANAGER')">Fecha Creación</th>-->
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="ticket : ${tickets}">
                        <td th:text="${ticket.idTicket}">ID</td>
                        <td th:text="${ticket.descripcion}">Título</td>
                        <td th:text="${ticket.estado != null ? ticket.estado.name() : 'N/A'}">Estado</td>
                        <td th:text="${ticket.prioridad != null ? ticket.prioridad.name() : 'N/A'}">Prioridad</td>
						<td th:text="${ticket.fechaCreacion != null ? ticket.fechaCreacion : 'N/A'}">Fecha Creación</td>
<!--                        <td sec:authorize="hasAnyRole('ROLE_EMPLEADO', 'ROLE_MANAGER')"-->
<!--                            th:text="${ticket.fechaCreacion != null ? ticket.fechaCreacion : 'N/A'}">-->
<!--                            Fecha Creación-->
<!--                        </td>-->

<<<<<<< HEAD
                        <td>
                            <div class="action-group-container">
                                <span sec:authorize="hasAnyRole('ROLE_EMPLEADO', 'ROLE_MANAGER')">
                                    <span th:if="${ticket.estado?.name() == 'ABIERTO'}">
                                        <span th:if="${usuarioLogueado?.area != null and ticket.area != null and ticket.area.equals(usuarioLogueado.area)}">
                                            <a th:href="@{/ticket/{idTicket}/tomarTicket(idTicket=${ticket.idTicket})}"
                                               class="btn btn-sm btn-success">
                                                <i class="fas fa-hand-paper"></i> Tomar Ticket
                                            </a>
                                        </span>
                                    </span>
                                    <span th:unless="${ticket.estado != null and ticket.estado.name() == 'ABIERTO'}">
                                        <button class="btn btn-sm btn-secondary" disabled
                                                th:text="${ticket.estado != null ? 'Estado: ' + ticket.estado.name() : 'Estado: N/A'}"></button>
=======
    <div th:unless="${#lists.isEmpty(tickets)}" class="table-responsive">
        <table class="table table-bordered table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Estado</th>
                    <th>Prioridad</th>
                    <th>Área Asignada</th>
                    <th>Acciones</th>
                    <th>Última Función</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="ticket : ${tickets}">
                    <td th:text="${ticket.idTicket}">ID</td>
                    <td th:text="${ticket.titulo}">Título</td>
                    <td th:text="${ticket.estado != null ? ticket.estado.name() : 'N/A'}">Estado</td>
                    <td th:text="${ticket.prioridad != null ? ticket.prioridad.name() : 'Sin Asignar'}">Prioridad</td>
                    <td th:text="${ticket.area != null ? ticket.area.name() : 'Sin Asignar'}">Área</td>
                    <td>
                        <div class="d-flex flex-column gap-1">
                            <span sec:authorize="hasAnyRole('ROLE_EMPLEADO', 'ROLE_MANAGER')">
                                <span th:if="${ticket.estado?.name() == 'ABIERTO'}">
                                    <a th:href="@{/ticket/{idTicket}/tomarTicket(idTicket=${ticket.idTicket})}" 
                                       class="btn btn-sm btn-success">Tomar Ticket</a>
>>>>>>> refs/remotes/origin/pauche
                                    </span>
                                </span>

                                <div class="d-flex justify-content-center gap-2 w-100 main-action-buttons">
                                    <a th:href="@{/ticket/{idTicket}/detail(idTicket=${ticket.idTicket})}"
                                       class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-info-circle"></i> Detalles
                                    </a>

                                    <button type="button" class="btn btn-sm btn-change-state"
                                            th:data-ticket-id="${ticket.idTicket}"
                                            th:data-current-estado="${ticket.estado != null ? ticket.estado.name() : ''}"
                                            onclick="openChangeModal(this, 'estado')">
                                        <i class="fas fa-sync-alt"></i> Estado
                                    </button>

                                    <button type="button" class="btn btn-sm btn-change-priority"
                                            th:data-ticket-id="${ticket.idTicket}"
                                            th:data-current-prioridad="${ticket.prioridad != null ? ticket.prioridad.name() : ''}"
                                            onclick="openChangeModal(this, 'prioridad')">
                                        <i class="fas fa-exclamation-triangle"></i> Prioridad
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="changeModal" tabindex="-1" aria-labelledby="changeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeModalLabel">Cambiar <span id="changeTypeLabel"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="changeForm" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="_csrf" th:value="${_csrf.token}" />
                        <input type="hidden" id="modalTicketId" name="idTicket" value="" />

                        <div class="mb-3" id="stateSelectGroup">
                            <label for="modalEstado" class="form-label">Seleccione nuevo Estado:</label>
                            <select class="form-select" id="modalEstado" name="estado" required>
                                <option value="">Seleccionar</option>
                                <option th:each="estado : ${estados}" th:value="${estado.name()}" th:text="${estado.name()}">
                                </option>
                            </select>
                        </div>
<<<<<<< HEAD

                        <div class="mb-3" id="prioritySelectGroup">
                            <label for="modalPrioridad" class="form-label">Seleccione nueva Prioridad:</label>
                            <select class="form-select" id="modalPrioridad" name="prioridad" required>
                                <option value="">Seleccionar</option>
                                <option th:each="prioridad : ${prioridades}" th:value="${prioridad.name()}" th:text="${prioridad.name()}">
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
=======
                    </td>
                    <td th:text="${#lists.isEmpty(ticket.procesos) ? '' : ticket.procesos[ticket.procesos.size() - 1].funcion}">Función</td>
                </tr>
            </tbody>
        </table>
>>>>>>> refs/remotes/origin/pauche
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>

    <script>
        function openChangeModal(button, type) {
            const ticketId = button.dataset.ticketId;
            const changeModal = new bootstrap.Modal(document.getElementById('changeModal'));
            
            const changeForm = document.getElementById('changeForm');
            const modalTicketIdInput = document.getElementById('modalTicketId');
            const changeTypeLabel = document.getElementById('changeTypeLabel');
            const stateSelectGroup = document.getElementById('stateSelectGroup');
            const prioritySelectGroup = document.getElementById('prioritySelectGroup');
            const modalEstadoSelect = document.getElementById('modalEstado');
            const modalPrioridadSelect = document.getElementById('modalPrioridad');

            stateSelectGroup.style.display = 'none';
            prioritySelectGroup.style.display = 'none';
            modalEstadoSelect.required = false;
            modalPrioridadSelect.required = false;

            modalTicketIdInput.value = ticketId;

            if (type === 'estado') {
                changeTypeLabel.textContent = 'Estado'; 
                stateSelectGroup.style.display = 'block';
                modalEstadoSelect.required = true; 
                changeForm.action = `/ticket/${ticketId}/cambiarEstado`;
                const currentEstado = button.dataset.currentEstado;
                modalEstadoSelect.value = currentEstado;
            } else if (type === 'prioridad') {
                changeTypeLabel.textContent = 'Prioridad'; 
                prioritySelectGroup.style.display = 'block'; 
                modalPrioridadSelect.required = true; 
                changeForm.action = `/ticket/${ticketId}/cambiarPrioridad`;
                const currentPrioridad = button.dataset.currentPrioridad;
                modalPrioridadSelect.value = currentPrioridad;
            }

            changeModal.show();
        }
    </script>
</body>
</html>